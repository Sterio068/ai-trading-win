<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AI Trading  單機面板</title>
<style>
  body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;max-width:940px;margin:24px auto;padding:0 12px;}
  h1{font-size:20px;margin:0 0 8px}
  section{border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0}
  label{display:block;margin:6px 0 2px;font-weight:600}
  input,select{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  button{padding:10px 14px;border:0;border-radius:8px;background:#1f6feb;color:#fff;cursor:pointer}
  .muted{color:#666;font-size:12px}
  .ok{color:#17a34a}.err{color:#b42318}
  pre{white-space:pre-wrap;background:#fafafa;border:1px dashed #ddd;padding:8px;border-radius:6px}
</style>
</head>
<body>
  <h1>AI Trading  Windows 單機面板</h1>

  <section>
    <h3>環境與帳號（只保存在本機 .env）</h3>
    <div class="row">
      <div><label>OpenAI API Key</label><input id="OPENAI_API_KEY"/></div>
      <div><label>OpenAI 模型</label><input id="OPENAI_MODEL" value="gpt-5"/></div>
    </div>
    <div class="row">
      <div><label>OKX KEY</label><input id="OKX_API_KEY"/></div>
      <div><label>OKX SECRET</label><input id="OKX_API_SECRET"/></div>
    </div>
    <div class="row">
      <div><label>OKX PASSPHRASE</label><input id="OKX_API_PASSPHRASE"/></div>
      <div><label>模擬盤</label>
        <select id="OKX_SIMULATED"><option value="1">1</option><option value="0">0</option></select>
      </div>
    </div>
    <div class="muted">＊修改後請重啟後端服務或在 .env 寫入。</div>
  </section>

  <section>
    <h3>AI 偏好（會寫入 DB）</h3>
    <div class="row">
      <div><label>使用者</label><input id="user" value="you@example.com"/></div>
      <div><label>交易型別</label>
        <select id="instType"><option>SPOT</option><option>SWAP</option></select>
      </div>
    </div>
    <div class="row">
      <div><label>Symbols（以逗號分隔）</label><input id="symbols" value="BTC-USDT"/></div>
      <div><label>預算（SPOT）或 張數（SWAP）</label><input id="budget" value="20"/></div>
    </div>
    <button onclick="savePrefs()">儲存 AI 設定</button>
    <div id="msgPrefs" class="muted"></div>
  </section>

  <section>
    <h3>風控與時間窗</h3>
    <div class="row">
      <div><label>每幣種最大名目（USDT）</label><input id="max_symbol" value="2000"/></div>
      <div><label>總名目上限（USDT）</label><input id="max_total" value="5000"/></div>
    </div>
    <div class="row">
      <div><label>單日虧損停機（USDT）</label><input id="daily_loss" value="100"/></div>
      <div><label>交易時間窗（UTC，例如 08:00-23:30）</label><input id="win" value="00:00-23:59"/></div>
    </div>
    <button onclick="saveRisk()">儲存風控</button>
    <div id="msgRisk" class="muted"></div>
  </section>

  <section>
    <h3>一鍵 AI 交易</h3>
    <div class="row">
      <div><button onclick="runDCA()">立即執行 DCA</button></div>
      <div><button onclick="testInstrument()">查規則/名目（顯示提示）</button></div>
    </div>
    <pre id="out"></pre>
  </section>

<script>
const BASE = location.origin;
function val(id){ return document.getElementById(id).value.trim() }
function msg(id,t,ok=true){ const el=document.getElementById(id); el.textContent=t; el.className=ok?"ok":"err" }

async function savePrefs(){
  const user=val('user'), instType=val('instType'), budget=parseFloat(val('budget')), symbols=val('symbols').split(',').map(s=>s.trim()).filter(Boolean);
  const body = { user_id:user, key:"dca", data:{ symbols, instType, ...(instType==="SWAP"?{}:{budget}) , ...(instType==="SWAP"?{sz:budget}:{}) } };
  const r = await fetch(`${BASE}/api/ai/settings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  msg('msgPrefs', r.ok?"已儲存":"失敗", r.ok);
}

async function saveRisk(){
  const user=val('user');
  const body = { user_id:user, max_notional_per_symbol:parseFloat(val('max_symbol')), max_total_notional:parseFloat(val('max_total')), daily_loss_stop:parseFloat(val('daily_loss')), window:val('win') };
  const r = await fetch(`${BASE}/api/risk/limits`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  msg('msgRisk', r.ok?"已儲存":"失敗", r.ok);
}

async function runDCA(){
  const user=val('user');
  const r = await fetch(`${BASE}/api/strategy/run`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"dca", user_id:user})});
  const js = await r.json();
  document.getElementById('out').textContent = JSON.stringify(js,null,2);
}

async function testInstrument(){
  const instType=val('instType'); const first = val('symbols').split(',')[0].trim();
  const url = `${BASE}/api/okx/instrument?inst=${encodeURIComponent(first)}&instType=${encodeURIComponent(instType)}&notional=25`;
  const r = await fetch(url); const js = await r.json();
  document.getElementById('out').textContent = JSON.stringify(js,null,2);
}
</script>
</body>
</html>
